---
- id: 243053d2-13c1-47f0-832d-6ef02ba95e1a
  name: Backup Sensitive Directories
  description: Create compressed backups of sensitive directories
  tactic: setup
  technique:
    attack_id: x
    name: x
  repeatable: False
  platforms:
    linux:
      sh:
        command: |
          mkdir -p /tmp/sensitive_file_backups;
          dir_path=$(echo "#{directory.sensitive.path}" | sed 's/\\\*/\*/g');
          directories=$(find $dir_path -maxdepth 0 -type d 2>/dev/null);
          output="";
          for directory in $directories;
            do randname=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13);
            tar -czf /tmp/sensitive_file_backups/${randname}.tar.gz -C $directory .;
            output="${output}${directory}>${randname}\n";
          done;
          echo $output | sed '/^[[:space:]]*$/d'
        parsers:
          plugins.response.app.parsers.key_value:
            - source: directory.sensitive.path
              edge: has_backup
              target: directory.backup.name
        cleanup: |
          rm -rf /tmp/sensitive_file_backups;
    darwin:
      sh:
        command: |
          mkdir -p /tmp/sensitive_file_backups;
          dir_path=$(echo "#{directory.sensitive.path}" | sed 's/\\\*/\*/g');
          directories=$(find $dir_path -maxdepth 0 -type d 2>/dev/null);
          output="";
          for directory in $directories;
            do randname=$(head /dev/urandom | LC_CTYPE=C tr -dc A-Za-z0-9 | head -c 13);
            tar -czf /tmp/sensitive_file_backups/${randname}.tar.gz -C $directory .;
            output="${output}${directory}>${randname}.tar.gz\n";
          done;
          echo $output | sed '/^[[:space:]]*$/d'
        parsers:
          plugins.response.app.parsers.key_value:
            - source: directory.sensitive.path
              edge: has_backup
              target: directory.backup.name
        cleanup: |
          rm -rf /tmp/sensitive_file_backups;
  requirements:
    - plugins.response.app.requirements.source_fact:
        - source: directory.sensitive.path
